# ğŸ—ï¸ Arquitectura Completa - Infrastructure AI Platform

## Diagrama Principal del Sistema Completo

```mermaid
graph TB
    subgraph "Usuario/Cliente"
        USER[ğŸ‘¤ Usuario]
        DEV[ğŸ‘¨â€ğŸ’» Developer]
        ARCH[ğŸ—ï¸ Architect]
    end
    
    subgraph "Backstage IDP Platform"
        subgraph "Frontend - React App"
            UI[ğŸ–¥ï¸ Backstage UI<br/>Port: 3000]
            CAT[ğŸ“‹ Service Catalog]
            TEMP[ğŸ“ Templates]
            DOCS[ğŸ“š TechDocs]
        end
        
        subgraph "Backend - Node.js"
            API_BS[ğŸ”Œ Backstage API<br/>Port: 7007]
            PROC_BS[âš™ï¸ Catalog Processor]
            AUTH[ğŸ” Authentication]
        end
    end
    
    subgraph "Infra AI Agent - Core System"
        subgraph "API Layer"
            FASTAPI[ğŸš€ FastAPI Server<br/>Port: 8000]
            ENDPOINTS[ğŸ“ Endpoints<br/>/process-diagram<br/>/process-text<br/>/analyze-architecture]
        end
        
        subgraph "Processing Layer"
            VISION[ğŸ‘ï¸ Vision Processor<br/>Gemini Vision API]
            TEXT[ğŸ“ Text Processor<br/>Gemini Text API]
            ROUTER[ğŸ”€ Request Router]
        end
        
        subgraph "AI Integration"
            GEMINI_V[ğŸ¤– Gemini Vision<br/>gemini-1.5-pro]
            GEMINI_T[ğŸ¤– Gemini Text<br/>gemini-1.5-pro]
            PROMPT_ENG[âš™ï¸ Prompt Engineering]
        end
        
        subgraph "Generation & Validation"
            YAML_GEN[ğŸ“„ YAML Generator]
            VALIDATOR[âœ… Backstage Validator]
            MAPPER[ğŸ—ºï¸ Service Mapper<br/>AWS â†’ Backstage]
        end
        
        subgraph "Integration Layer"
            GIT_CLIENT[ğŸ“¦ Git Client]
            WEBHOOK[ğŸ”— Webhook Handler]
            METRICS[ğŸ“Š Metrics Collector]
        end
    end
    
    subgraph "External Services"
        GOOGLE_AI[ğŸŒ Google AI Platform<br/>Gemini APIs]
        GITHUB[ğŸ™ GitHub<br/>Repositories]
    end
    
    subgraph "Storage & Repositories"
        subgraph "Agent Repository"
            AGENT_REPO[ğŸ“ infra-ai-agent<br/>Python Code]
        end
        
        subgraph "Templates Repository"
            TEMPLATES_REPO[ğŸ“ catalog-repo<br/>YAML Files]
            COMPONENTS[ğŸ§© Components]
            RESOURCES[ğŸ—ƒï¸ Resources]
            SYSTEMS[ğŸ—ï¸ Systems]
        end
        
        subgraph "Backstage Repository"
            BS_REPO[ğŸ“ backstage-idp<br/>Node.js App]
            BS_CONFIG[âš™ï¸ app-config.yaml]
            BS_PLUGINS[ğŸ”Œ Plugins]
        end
    end
    
    %% User Interactions
    USER --> UI
    DEV --> UI
    ARCH --> UI
    USER --> FASTAPI
    
    %% Backstage Internal Flow
    UI --> API_BS
    API_BS --> PROC_BS
    PROC_BS --> CAT
    CAT --> TEMP
    CAT --> DOCS
    
    %% AI Agent Processing Flow
    FASTAPI --> ENDPOINTS
    ENDPOINTS --> ROUTER
    ROUTER -->|PNG Image| VISION
    ROUTER -->|Text Description| TEXT
    ROUTER -->|Hybrid Request| VISION
    ROUTER -->|Hybrid Request| TEXT
    
    %% AI Processing
    VISION --> GEMINI_V
    TEXT --> GEMINI_T
    GEMINI_V --> GOOGLE_AI
    GEMINI_T --> GOOGLE_AI
    GOOGLE_AI --> PROMPT_ENG
    PROMPT_ENG --> YAML_GEN
    
    %% Validation & Generation
    YAML_GEN --> MAPPER
    MAPPER --> VALIDATOR
    VALIDATOR --> GIT_CLIENT
    
    %% External Integrations
    GIT_CLIENT --> GITHUB
    GITHUB --> TEMPLATES_REPO
    TEMPLATES_REPO --> COMPONENTS
    TEMPLATES_REPO --> RESOURCES
    TEMPLATES_REPO --> SYSTEMS
    
    %% Backstage Integration
    TEMPLATES_REPO --> PROC_BS
    PROC_BS --> CAT
    WEBHOOK --> METRICS
    
    %% Repository Management
    AGENT_REPO --> FASTAPI
    BS_REPO --> UI
    BS_CONFIG --> API_BS
    
    %% Styling
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef backstageClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef aiClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef storageClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef externalClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    
    class USER,DEV,ARCH userClass
    class UI,CAT,TEMP,DOCS,API_BS,PROC_BS,AUTH backstageClass
    class FASTAPI,ENDPOINTS,ROUTER,VISION,TEXT,YAML_GEN,VALIDATOR,MAPPER,GIT_CLIENT,WEBHOOK,METRICS,GEMINI_V,GEMINI_T,PROMPT_ENG aiClass
    class AGENT_REPO,TEMPLATES_REPO,BS_REPO,COMPONENTS,RESOURCES,SYSTEMS,BS_CONFIG,BS_PLUGINS storageClass
    class GOOGLE_AI,GITHUB externalClass
```

## Estructura Completa del Proyecto

```mermaid
graph TD
    subgraph "ğŸ“ /home/giovanemere/demos/"
        subgraph "ğŸ¤– infra-ai-agent/"
            AGENT_CODE[ğŸ“„ Python Code<br/>FastAPI + Gemini]
            AGENT_DOCS[ğŸ“š Documentation]
            AGENT_CONFIG[âš™ï¸ Configuration]
        end
        
        subgraph "ğŸ“ catalog-repo/"
            CATALOG_YAML[ğŸ“„ YAML Files<br/>Generated by AI]
            CATALOG_COMP[ğŸ§© Components]
            CATALOG_RES[ğŸ—ƒï¸ Resources]
        end
        
        subgraph "ğŸ­ backstage-idp/"
            BS_APP[ğŸ“± Backstage App<br/>Node.js + React]
            BS_CONFIG_FILE[âš™ï¸ app-config.yaml]
            BS_SCRIPTS[ğŸ”§ Setup Scripts]
        end
        
        PROJECT_DOCS[ğŸ“‹ REPOSITORY_STRUCTURE.md]
    end
    
    subgraph "ğŸŒ GitHub Repositories"
        REPO1[ğŸ“¦ demo-infra-ai-agent]
        REPO2[ğŸ“¦ demo-infra-ai-agent-template-idp]
        REPO3[ğŸ“¦ backstage-idp<br/>ğŸ†• Nuevo]
    end
    
    subgraph "ğŸš€ Running Services"
        SERVICE1[ğŸ¤– AI Agent<br/>:8000]
        SERVICE2[ğŸ­ Backstage<br/>:3000/:7007]
    end
    
    AGENT_CODE --> REPO1
    CATALOG_YAML --> REPO2
    BS_APP --> REPO3
    
    REPO1 --> SERVICE1
    REPO3 --> SERVICE2
    
    SERVICE1 --> CATALOG_YAML
    CATALOG_YAML --> SERVICE2
```

## Flujo de Datos Completo

```mermaid
sequenceDiagram
    participant U as Usuario
    participant BS as Backstage UI
    participant AI as AI Agent
    participant G as Gemini API
    participant GH as GitHub
    participant CAT as Catalog

    Note over U,CAT: Flujo Completo de AnÃ¡lisis y CatalogaciÃ³n
    
    U->>BS: Accede a Backstage IDP
    BS->>U: Muestra catÃ¡logo actual
    
    U->>AI: EnvÃ­a diagrama/texto
    AI->>G: Procesa con Gemini
    G->>AI: Retorna anÃ¡lisis
    AI->>AI: Genera YAML
    AI->>GH: Commit a templates repo
    
    GH->>BS: Webhook/Polling
    BS->>CAT: Actualiza catÃ¡logo
    CAT->>BS: Nuevos componentes
    BS->>U: Notifica actualizaciÃ³n
    
    U->>BS: Ve nuevos componentes
    BS->>U: Muestra arquitectura catalogada
```

## Arquitectura de Despliegue

```mermaid
graph TB
    subgraph "ğŸ–¥ï¸ Desarrollo Local"
        subgraph "Puertos"
            PORT3000[":3000<br/>Backstage UI"]
            PORT7007[":7007<br/>Backstage API"]
            PORT8000[":8000<br/>AI Agent API"]
        end
        
        subgraph "Procesos"
            PROC1[ğŸ­ yarn dev<br/>Backstage]
            PROC2[ğŸ¤– uvicorn<br/>AI Agent]
        end
    end
    
    subgraph "â˜ï¸ Servicios Externos"
        GEMINI[ğŸ¤– Google Gemini API]
        GITHUB_SVC[ğŸ™ GitHub API]
    end
    
    subgraph "ğŸ’¾ Almacenamiento"
        SQLITE[ğŸ“„ SQLite<br/>Backstage DB]
        FILES[ğŸ“ File System<br/>Configs & Logs]
    end
    
    PORT3000 --> PROC1
    PORT7007 --> PROC1
    PORT8000 --> PROC2
    
    PROC1 --> SQLITE
    PROC1 --> GITHUB_SVC
    PROC2 --> GEMINI
    PROC2 --> GITHUB_SVC
    
    PROC1 --> FILES
    PROC2 --> FILES
```

## Flujo de Procesamiento Detallado

```mermaid
sequenceDiagram
    participant U as Usuario
    participant API as FastAPI
    participant VP as Vision Processor
    participant TP as Text Processor
    participant G as Gemini API
    participant YG as YAML Generator
    participant V as Validator
    participant GC as Git Client
    participant GH as GitHub
    participant BS as Backstage

    Note over U,BS: Flujo de AnÃ¡lisis de Diagrama PNG
    
    U->>+API: POST /process-diagram (PNG file)
    API->>+VP: analyze_diagram(image_path)
    VP->>+G: generate_content([prompt, image])
    G-->>-VP: YAML content
    VP-->>-API: Generated YAML
    
    API->>+YG: process_yaml(content)
    YG->>+V: validate_yaml(content)
    V-->>-YG: validation_result
    YG-->>-API: Processed YAML
    
    alt Validation Success
        API->>+GC: save_yaml(filename, content)
        GC->>+GH: git commit & push
        GH-->>-GC: commit_url
        GC-->>-API: github_url
        
        GH->>BS: Webhook/Polling trigger
        BS->>BS: Update catalog
        
        API-->>U: Success response with URLs
    else Validation Failed
        API-->>U: Error response
    end

    Note over U,BS: Flujo de AnÃ¡lisis de Texto
    
    U->>+API: POST /process-text (description)
    API->>+TP: analyze_text(description)
    TP->>+G: generate_content(prompt)
    G-->>-TP: YAML content
    TP-->>-API: Generated YAML
    
    API->>+YG: process_yaml(content)
    YG->>+V: validate_yaml(content)
    V-->>-YG: validation_result
    YG-->>-API: Processed YAML
    
    alt Validation Success
        API->>+GC: save_yaml(filename, content)
        GC->>+GH: git commit & push
        GH-->>-GC: commit_url
        GC-->>-API: github_url
        
        GH->>BS: Webhook/Polling trigger
        BS->>BS: Update catalog
        
        API-->>U: Success response with URLs
    else Validation Failed
        API-->>U: Error response
    end
```

## Arquitectura de Componentes Backstage

```mermaid
graph LR
    subgraph "Backstage IDP"
        subgraph "Systems"
            SYS1[ğŸ—ï¸ infra-ai-agent-system]
        end
        
        subgraph "Components"
            COMP1[ğŸš€ infra-ai-agent-api]
            COMP2[ğŸ‘ï¸ vision-processor]
            COMP3[ğŸ“ text-processor]
            COMP4[ğŸ“„ yaml-generator]
            COMP5[âœ… backstage-validator]
            COMP6[ğŸ“¦ git-client]
        end
        
        subgraph "Resources"
            RES1[ğŸ“ templates-repository]
        end
        
        subgraph "APIs"
            API1[ğŸ”Œ architecture-analysis-api]
            API2[ğŸŒ gemini-vision-api]
            API3[ğŸŒ gemini-text-api]
        end
    end
    
    %% System relationships
    SYS1 --> COMP1
    SYS1 --> COMP2
    SYS1 --> COMP3
    SYS1 --> COMP4
    SYS1 --> COMP5
    SYS1 --> COMP6
    SYS1 --> RES1
    
    %% Component dependencies
    COMP1 --> COMP2
    COMP1 --> COMP3
    COMP1 --> COMP4
    COMP1 --> COMP6
    COMP4 --> COMP5
    COMP6 --> RES1
    
    %% API relationships
    COMP1 --> API1
    COMP2 --> API2
    COMP3 --> API3
    
    %% Styling
    classDef systemClass fill:#e3f2fd,stroke:#0277bd,stroke-width:3px
    classDef componentClass fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef resourceClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    classDef apiClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    
    class SYS1 systemClass
    class COMP1,COMP2,COMP3,COMP4,COMP5,COMP6 componentClass
    class RES1 resourceClass
    class API1,API2,API3 apiClass
```

## Mapeo de Servicios AWS a Backstage

```mermaid
graph TD
    subgraph "AWS Services"
        S3[ğŸª£ S3 Bucket]
        LAMBDA[âš¡ Lambda Function]
        CF[ğŸŒ CloudFront]
        APIGW[ğŸšª API Gateway]
        RDS[ğŸ—„ï¸ RDS Database]
        DYNAMO[âš¡ DynamoDB]
        R53[ğŸŒ Route53]
        CW[ğŸ“Š CloudWatch]
        ECS[ğŸ³ ECS/Fargate]
        ALB[âš–ï¸ Load Balancer]
    end
    
    subgraph "Backstage Catalog"
        subgraph "Resources"
            R_STORAGE[ğŸ“¦ Resource<br/>type: storage]
            R_DATABASE[ğŸ—ƒï¸ Resource<br/>type: database]
            R_DNS[ğŸŒ Resource<br/>type: dns]
            R_MONITOR[ğŸ“Š Resource<br/>type: monitoring]
        end
        
        subgraph "Components"
            C_SERVICE[âš™ï¸ Component<br/>type: service]
            C_CDN[ğŸŒ Component<br/>type: cdn]
            C_API[ğŸ”Œ Component<br/>type: api]
            C_LB[âš–ï¸ Component<br/>type: load-balancer]
            C_WEBSITE[ğŸŒ Component<br/>type: website]
        end
    end
    
    %% Mappings
    S3 --> R_STORAGE
    RDS --> R_DATABASE
    DYNAMO --> R_DATABASE
    R53 --> R_DNS
    CW --> R_MONITOR
    
    LAMBDA --> C_SERVICE
    ECS --> C_SERVICE
    CF --> C_CDN
    APIGW --> C_API
    ALB --> C_LB
    
    %% Styling
    classDef awsClass fill:#ff9800,stroke:#e65100,stroke-width:2px,color:#fff
    classDef resourceClass fill:#4caf50,stroke:#2e7d32,stroke-width:2px,color:#fff
    classDef componentClass fill:#2196f3,stroke:#1565c0,stroke-width:2px,color:#fff
    
    class S3,LAMBDA,CF,APIGW,RDS,DYNAMO,R53,CW,ECS,ALB awsClass
    class R_STORAGE,R_DATABASE,R_DNS,R_MONITOR resourceClass
    class C_SERVICE,C_CDN,C_API,C_LB,C_WEBSITE componentClass
```

## Estados del Procesamiento

```mermaid
stateDiagram-v2
    [*] --> Received: Request received
    
    Received --> Processing: Start analysis
    Processing --> VisionAnalysis: PNG input
    Processing --> TextAnalysis: Text input
    Processing --> HybridAnalysis: Mixed input
    
    VisionAnalysis --> YAMLGeneration: Gemini Vision response
    TextAnalysis --> YAMLGeneration: Gemini Text response
    HybridAnalysis --> YAMLGeneration: Combined analysis
    
    YAMLGeneration --> Validation: YAML created
    
    Validation --> ValidationPassed: Schema valid
    Validation --> ValidationFailed: Schema invalid
    
    ValidationPassed --> GitCommit: Save to repository
    ValidationFailed --> Error: Return error
    
    GitCommit --> BackstageUpdate: Push successful
    GitCommit --> GitError: Push failed
    
    BackstageUpdate --> Success: Catalog updated
    GitError --> Error: Git operation failed
    
    Success --> [*]
    Error --> [*]
    
    note right of VisionAnalysis
        Gemini Vision API
        Analyzes PNG diagrams
        Extracts AWS services
    end note
    
    note right of TextAnalysis
        Gemini Text API
        Processes descriptions
        Identifies architecture
    end note
    
    note right of Validation
        Backstage schema validation
        YAML syntax check
        Dependency verification
    end note
```
