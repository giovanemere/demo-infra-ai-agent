#!/bin/bash

# =============================================================================
# Infrastructure AI Platform - Master CLI
# =============================================================================

set -e

# Colores
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() { echo -e "${BLUE}ðŸ”µ $1${NC}"; }
log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }

# FunciÃ³n para mostrar ayuda
show_help() {
    echo "ðŸš€ Infrastructure AI Platform CLI"
    echo "================================="
    echo ""
    echo "Comandos disponibles:"
    echo "  start         - Iniciar toda la plataforma"
    echo "  stop          - Detener todos los servicios"
    echo "  status        - Ver estado de servicios"
    echo "  setup         - ConfiguraciÃ³n inicial"
    echo "  restart       - Reiniciar plataforma"
    echo "  logs          - Ver logs de servicios"
    echo "  install-deps  - Instalar dependencias Python"
    echo "  help          - Mostrar esta ayuda"
    echo ""
    echo "Ejemplos:"
    echo "  ./platform-cli start"
    echo "  ./platform-cli status"
    echo "  ./platform-cli logs ai-agent"
    echo "  ./platform-cli install-deps"
    echo ""
    echo "Notas:"
    echo "  - Docker es opcional (PostgreSQL se omite si no estÃ¡ disponible)"
    echo "  - Node.js es opcional (Backstage se omite si no estÃ¡ disponible)"
    echo "  - Solo Python3 es requerido para el AI Agent"
}

# Verificar prerequisitos
check_prerequisites() {
    log_info "Verificando prerequisitos..."
    
    # Python (requerido)
    if ! command -v python3 &> /dev/null; then
        log_error "Python3 no encontrado"
        exit 1
    fi
    
    # Node.js (opcional para Backstage)
    if ! command -v node &> /dev/null; then
        log_warning "Node.js no encontrado. Backstage no estarÃ¡ disponible."
        log_info "Para instalar: curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - && sudo apt-get install -y nodejs"
        SKIP_BACKSTAGE=true
    fi
    
    # Docker (opcional para PostgreSQL)
    if ! command -v docker &> /dev/null; then
        log_warning "Docker no encontrado. PostgreSQL no estarÃ¡ disponible."
        log_info "Backstage usarÃ¡ SQLite en su lugar."
        SKIP_POSTGRES=true
    fi
    
    log_success "Prerequisitos verificados"
}

# 1. PostgreSQL (Puerto 5432)
start_postgres() {
    if [ "$SKIP_POSTGRES" = true ]; then
        log_warning "PostgreSQL omitido - Docker no disponible"
        return 0
    fi
    
    log_info "Iniciando PostgreSQL..."
    
    if ! nc -z localhost 5432 2>/dev/null; then
        if [ -f "/home/giovanemere/docker/postgres/start-postgres.sh" ]; then
            cd /home/giovanemere/docker/postgres
            ./start-postgres.sh
            sleep 5
            cd /home/giovanemere/demos/infra-ai-agent
            log_success "PostgreSQL iniciado en puerto 5432"
        else
            log_warning "PostgreSQL setup no encontrado, continuando sin base de datos"
        fi
    else
        log_warning "PostgreSQL ya estÃ¡ ejecutÃ¡ndose"
    fi
}

# 2. AI Agent (Puerto 8000)
start_ai_agent() {
    log_info "Iniciando AI Agent..."
    
    if ! curl -s http://localhost:8000/health &>/dev/null; then
        # Verificar .env
        if [ ! -f ".env" ]; then
            log_warning "Archivo .env no encontrado, creando desde .env.example"
            if [ -f ".env.example" ]; then
                cp .env.example .env
                log_warning "âš ï¸  Configura GEMINI_API_KEY en .env antes de usar el agente"
            else
                log_error "No se encontrÃ³ .env.example"
                return 1
            fi
        fi
        
        # Verificar API key
        if grep -q "your_gemini_api_key_here" .env 2>/dev/null; then
            log_warning "GEMINI_API_KEY no configurado - el agente funcionarÃ¡ con limitaciones"
        fi
        
        # Instalar dependencias si es necesario
        if ! python3 -c "import fastapi" 2>/dev/null; then
            log_info "Instalando dependencias Python..."
            python3 -m pip install --user fastapi uvicorn google-generativeai pillow pyyaml python-multipart 2>/dev/null || {
                log_warning "No se pudieron instalar dependencias automÃ¡ticamente"
                log_info "Instala manualmente: pip install fastapi uvicorn google-generativeai pillow pyyaml python-multipart"
            }
        fi
        
        # Iniciar AI Agent
        log_info "Iniciando servidor AI Agent..."
        nohup python3 -m uvicorn agent.main:app --host 0.0.0.0 --port 8000 > ai-agent.log 2>&1 &
        AI_PID=$!
        echo $AI_PID > ai-agent.pid
        sleep 5
        
        # Verificar que iniciÃ³ correctamente
        if curl -s http://localhost:8000/health &>/dev/null; then
            log_success "AI Agent iniciado en puerto 8000"
        else
            log_warning "AI Agent puede tener problemas - revisa ai-agent.log"
        fi
    else
        log_warning "AI Agent ya estÃ¡ ejecutÃ¡ndose"
    fi
}

# 3. Backstage (Puertos 3000/7007)
start_backstage() {
    if [ "$SKIP_BACKSTAGE" = true ]; then
        log_warning "Backstage omitido - Node.js no disponible"
        return 0
    fi
    
    log_info "Iniciando Backstage..."
    
    if ! curl -s http://localhost:3000 &>/dev/null; then
        local backstage_path="/home/giovanemere/demos/backstage-idp"
        
        if [ ! -d "$backstage_path" ]; then
            log_warning "Backstage no encontrado en $backstage_path"
            return 1
        fi
        
        cd "$backstage_path"
        
        # Verificar si estÃ¡ configurado
        if [ ! -d "infra-ai-backstage" ]; then
            log_info "Backstage no configurado, ejecutando setup..."
            if [ -f "./setup-backstage.sh" ]; then
                ./setup-backstage.sh
            else
                log_warning "Setup de Backstage no encontrado"
                cd /home/giovanemere/demos/infra-ai-agent
                return 1
            fi
        fi
        
        # Verificar .env
        if [ ! -f "infra-ai-backstage/.env" ]; then
            log_warning "Variables de entorno no configuradas para Backstage"
            log_info "Configura GITHUB_TOKEN en infra-ai-backstage/.env"
        fi
        
        # Intentar iniciar Backstage
        if [ -f "./scripts/start-backstage.sh" ]; then
            nohup ./scripts/start-backstage.sh > backstage.log 2>&1 &
            BS_PID=$!
            echo $BS_PID > /home/giovanemere/demos/infra-ai-agent/backstage.pid
            sleep 10
            log_success "Backstage iniciado en puertos 3000/7007"
        else
            log_warning "Script de inicio de Backstage no encontrado"
        fi
        
        cd /home/giovanemere/demos/infra-ai-agent
    else
        log_warning "Backstage ya estÃ¡ ejecutÃ¡ndose"
    fi
}

# Verificar estado de servicios
check_status() {
    log_info "Verificando estado de servicios..."
    
    # PostgreSQL
    if nc -z localhost 5432 2>/dev/null; then
        log_success "PostgreSQL: Funcionando (puerto 5432)"
    else
        log_error "PostgreSQL: No disponible"
    fi
    
    # AI Agent
    if curl -s http://localhost:8000/health &>/dev/null; then
        log_success "AI Agent: Funcionando (puerto 8000)"
    else
        log_error "AI Agent: No disponible"
    fi
    
    # Backstage UI
    if curl -s http://localhost:3000 &>/dev/null; then
        log_success "Backstage UI: Funcionando (puerto 3000)"
    else
        log_error "Backstage UI: No disponible"
    fi
    
    # Backstage API
    if curl -s http://localhost:7007 &>/dev/null; then
        log_success "Backstage API: Funcionando (puerto 7007)"
    else
        log_error "Backstage API: No disponible"
    fi
}

# Detener servicios
stop_services() {
    log_info "Deteniendo servicios..."
    
    # AI Agent
    if [ -f "ai-agent.pid" ]; then
        AI_PID=$(cat ai-agent.pid)
        kill $AI_PID 2>/dev/null && log_success "AI Agent detenido"
        rm ai-agent.pid
    fi
    
    # Backstage
    if [ -f "backstage.pid" ]; then
        BS_PID=$(cat backstage.pid)
        kill $BS_PID 2>/dev/null && log_success "Backstage detenido"
        rm backstage.pid
    fi
    
    # PostgreSQL
    cd /home/giovanemere/docker/postgres
    docker-compose down && log_success "PostgreSQL detenido"
    cd /home/giovanemere/demos
    
    # Limpiar procesos restantes
    pkill -f "uvicorn.*8000" 2>/dev/null || true
    pkill -f "yarn.*dev" 2>/dev/null || true
}

# Setup inicial
setup_platform() {
    log_info "Configurando plataforma..."
    
    check_prerequisites
    
    # Setup AI Agent
    cd infra-ai-agent
    ./setup.sh
    cd ..
    
    # Setup Backstage
    cd backstage-idp
    ./setup-backstage.sh
    cd ..
    
    log_success "Setup completado"
    log_warning "Configura las variables de entorno antes de iniciar:"
    log_info "1. GEMINI_API_KEY en infra-ai-agent/.env"
    log_info "2. GITHUB_TOKEN en backstage-idp/infra-ai-backstage/.env"
}

# Ver logs
show_logs() {
    local service=$1
    
    case $service in
        "postgres")
            docker logs backstage-postgres -f
            ;;
        "ai-agent")
            tail -f infra-ai-agent/logs/agent.log 2>/dev/null || echo "No hay logs disponibles"
            ;;
        "backstage")
            tail -f backstage-idp/infra-ai-backstage/packages/backend/dist/logs/backend.log 2>/dev/null || echo "No hay logs disponibles"
            ;;
        *)
            log_error "Servicio no vÃ¡lido. Opciones: postgres, ai-agent, backstage"
            ;;
    esac
}

# FunciÃ³n principal
main() {
    # Variables globales
    SKIP_POSTGRES=false
    SKIP_BACKSTAGE=false
    
    case ${1:-help} in
        "start")
            log_info "ðŸš€ Iniciando Infrastructure AI Platform..."
            check_prerequisites
            start_postgres
            start_ai_agent
            start_backstage
            echo ""
            log_success "ðŸŽ‰ Plataforma iniciada!"
            echo ""
            echo "ðŸŒ URLs disponibles:"
            echo "  ðŸ¤– AI Agent:    http://localhost:8000"
            echo "  ðŸ“š AI Docs:     http://localhost:8000/docs"
            if [ "$SKIP_BACKSTAGE" != true ]; then
                echo "  ðŸŽ­ Backstage:   http://localhost:3000"
                echo "  ðŸ”§ Backstage API: http://localhost:7007"
            fi
            if [ "$SKIP_POSTGRES" != true ]; then
                echo "  ðŸ˜ PostgreSQL:  localhost:5432"
            fi
            echo ""
            echo "ðŸ“‹ Para ver logs:"
            echo "  ./platform-cli logs ai-agent"
            if [ "$SKIP_BACKSTAGE" != true ]; then
                echo "  ./platform-cli logs backstage"
            fi
            ;;
        "stop")
            log_info "ðŸ›‘ Deteniendo Infrastructure AI Platform..."
            stop_services
            log_success "Plataforma detenida"
            ;;
        "status")
            check_status
            ;;
        "setup")
            setup_platform
            ;;
        "restart")
            log_info "ðŸ”„ Reiniciando plataforma..."
            stop_services
            sleep 3
            check_prerequisites
            start_postgres
            start_ai_agent
            start_backstage
            log_success "Plataforma reiniciada"
            ;;
        "logs")
            show_logs $2
            ;;
        "install-deps")
            log_info "ðŸ”§ Instalando dependencias..."
            # Intentar diferentes mÃ©todos de instalaciÃ³n
            if command -v pip3 &> /dev/null; then
                pip3 install --user fastapi uvicorn google-generativeai pillow pyyaml python-multipart
            elif python3 -c "import pip" 2>/dev/null; then
                python3 -m pip install --user fastapi uvicorn google-generativeai pillow pyyaml python-multipart
            else
                log_warning "pip no disponible. Instalando con apt..."
                sudo apt update && sudo apt install -y python3-pip
                python3 -m pip install --user fastapi uvicorn google-generativeai pillow pyyaml python-multipart
            fi
            log_success "Dependencias instaladas"
            ;;
        "help"|*)
            show_help
            ;;
    esac
}

main "$@"
